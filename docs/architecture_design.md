# Agent 系统架构设计方案

**技术栈：TypeScript Agent Core + Python MCP Tools**

---

## 1. 设计目标与原则

### 1.1 核心目标
构建一个支持代码执行、文件操作、数据处理的智能 Agent 系统，具备多步骤任务规划与执行能力。

### 1.2 设计原则
- **语言解耦**：Agent 认知与编排逻辑使用 TypeScript（工程化、类型安全、前端亲和），工具执行层使用 Python（生态丰富、数据处理能力）。
- **协议标准化**：通过 MCP（Model Context Protocol）实现跨语言工具调用，确保工具可插拔、可替换。
- **安全隔离**：代码执行必须在沙箱环境中进行，与主进程物理隔离。
- **渐进式扩展**：支持从本地单机模式平滑过渡到分布式微服务架构。

---

## 2. 总体架构

### 2.1 分层架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      用户交互层                              │
│              (IDE 插件 / Web 界面 / CLI)                     │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP / WebSocket
┌──────────────────────▼──────────────────────────────────────┐
│                  Agent Core 层 (TypeScript)                  │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐    │
│  │   ReAct 引擎  │ │   任务规划器  │ │    记忆管理器     │    │
│  │  (推理循环)   │ │  (子任务分解) │ │  (上下文持久化)   │    │
│  └──────────────┘ └──────────────┘ └──────────────────┘    │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐    │
│  │   LLM 路由    │ │   MCP 客户端  │ │   会话管理器     │    │
│  │ (多模型适配)  │ │  (协议转换)   │ │  (状态机维护)    │    │
│  └──────┬───────┘ └──────┬───────┘ └──────────────────┘    │
└─────────┼────────────────┼──────────────────────────────────┘
          │                │
          │     ┌──────────┴──────────┐
          │     │   MCP 协议传输层     │
          │     │ (stdio / SSE / IPC) │
          │     └──────────┬──────────┘
          │                │
    ┌─────▼──────┐  ┌──────▼──────┐  ┌──────────────┐
    │  Python    │  │   Python    │  │   Node.js    │
    │ 代码执行沙箱 │  │  数据处理    │  │   系统工具    │
    │   Server   │  │   Server    │  │   Server     │
    │ (进程隔离)  │  │ (pandas/sql)│  │ (fs / cmd)   │
    └────────────┘  └─────────────┘  └──────────────┘
```

### 2.2 职责划分

| 层级 | 技术栈 | 核心职责 | 部署形态 |
|------|--------|----------|----------|
| **Agent Core** | TypeScript / Node.js | 任务规划、ReAct 循环、LLM 交互、会话管理 | 主进程 / 容器 |
| **MCP Client** | TypeScript | 维护与 Servers 的连接、工具发现、调用序列化 | 主进程内 |
| **MCP Servers** | Python / Node / Go | 具体工具实现（文件、命令、代码执行、数据库） | 子进程 / 独立服务 |
| **Sandbox** | Python (E2B/Docker) | 执行用户生成的代码，完全隔离 | 沙箱容器 |

---

## 3. Agent Core 层设计 (TypeScript)

### 3.1 ReAct 引擎模块
实现基于 ReAct（Reasoning + Acting）范式的推理循环，支持工作模式：
- **Code 模式**：Thought → Python Code → Observation，直接生成可执行 Python 代码片段，通过 MCP 交由 Python Server 执行。

引擎维护一个步骤队列（Step Queue），记录每一步的推理内容、工具调用参数、执行结果，用于构建 LLM 的 few-shot 上下文。

### 3.2 任务规划器 (Planner)
对复杂查询进行分解：
- **单步规划**：直接执行，适用于简单工具调用。
- **多步规划**：生成 DAG（有向无环图）形式的子任务序列，支持并行执行无依赖节点。
- **动态重规划**：根据工具执行结果（如文件不存在、权限不足）动态调整后续计划。

### 3.3 记忆管理器 (Memory Manager)
三级记忆体系：
- **短期记忆**：当前对话的滑动窗口（最近 N 轮交互）。
- **工作记忆**：当前任务的关键上下文（如正在处理的文件名、用户 ID、中间计算结果），以键值对形式维护。
- **长期记忆**：可持久化的任务摘要、用户偏好，支持向量检索（可选）。

### 3.4 LLM 路由层
统一封装多种 LLM 提供商（OpenAI、Anthropic、Azure、本地 vLLM），支持：
- **模型切换**：根据任务复杂度自动选择模型（简单任务用轻量模型，复杂推理用强模型）。
- **流式输出**：支持 SSE 流式返回，用于实时展示思考过程。
- **函数调用适配**：对不支持原生 Function Calling 的模型，通过 Prompt Engineering 模拟。

### 3.5 MCP 客户端管理器
- **连接管理**：维护与多个 MCP Servers 的长连接（stdio 或 SSE），支持热重连。
- **工具发现**：启动时从各 Server 获取工具列表与 JSON Schema，缓存在内存中。
- **调用路由**：根据工具名称路由到对应 Server，处理超时、重试、错误降级。

---

## 4. 工具层设计 (MCP Servers)

### 4.1 Python 代码执行沙箱 (Python Sandbox Server)
**定位**：专为安全执行 LLM 生成的 Python 代码而设计的 MCP Server。

**功能**：
- 接收代码字符串与超时参数，在受限环境中执行。
- 预置常用数据分析库（pandas、numpy、matplotlib）的环境，但禁止危险操作（网络请求、文件越权访问、系统命令）。
- 返回执行结果（stdout、stderr、变量值）或异常堆栈。

**安全机制**：
- **语法白名单**：通过 AST 分析禁止 import 非白名单模块。
- **资源限制**：CPU 时间、内存使用、磁盘 IO 上限。
- **进程隔离**：运行在独立进程或 Docker 容器中，与 Agent Core 物理隔离。

### 4.2 数据处理服务器 (Data Processing Server)
**定位**：针对特定数据任务的高阶封装，避免 LLM 写冗长代码。

**功能**：
- CSV/Excel 分析（描述统计、相关性分析、可视化）。
- SQL 查询执行与结果格式化。
- 文本处理（正则提取、格式转换）。

### 4.3 系统工具服务器 (System Tools Servers)
**技术栈可选 Node.js 或 Python**：
- **文件系统**：受限目录的文件读写、目录遍历（基于 `@modelcontextprotocol/server-filesystem`）。
- **命令执行**：受控的白名单命令执行（git、ls、cat 等），禁止任意 shell 执行。
- **网络请求**：受控的 HTTP 请求（防止 SSRF）。

---

## 5. 通信与协议设计

### 5.1 MCP 协议选型
Agent Core 与 Tools 之间采用 **Model Context Protocol**：
- **传输层**：本地开发使用 `stdio`（标准输入输出），生产环境使用 `SSE`（Server-Sent Events over HTTP）或 gRPC。
- **消息格式**：JSON-RPC 2.0，支持双向通信（工具可主动向 Agent 推送日志）。

### 5.2 类型契约
使用 JSON Schema 作为跨语言的类型契约：
- TypeScript 侧使用 Zod 或 TypeBox 进行运行时校验。
- Python 侧使用 Pydantic 或原生字典校验。
- 工具输入输出 Schema 由 MCP Server 在连接时自动发现，Agent Core 动态生成系统提示词（System Prompt）。

---

## 6. 安全架构

### 6.1 纵深防御策略

| 层级 | 防护措施 |
|------|----------|
| **Prompt 层** | 系统提示词注入安全约束（禁止生成恶意代码、路径遍历检查）。 |
| **工具层** | 所有工具（特别是文件、命令）实施路径白名单、命令白名单。 |
| **沙箱层** | Python 代码执行在受限进程/Docker 中，无网络访问，只读文件系统（除指定工作目录）。 |
| **传输层** | MCP 通信可启用加密（生产环境 SSE over HTTPS）。 |

### 6.2 敏感数据处理
- 环境变量（API Keys）由 Agent Core 注入到 MCP Servers，避免泄露到用户代码中。
- 日志脱敏：自动过滤 LLM 输出中的密码、Token 等敏感模式。

---

## 7. 部署架构

### 7.1 开发环境（本地模式）
- **Agent Core**：本地 Node.js 进程（`ts-node` 或 `tsx`）。
- **MCP Servers**：通过 `stdio` 启动为子进程，随 Agent 启停。
- **沙箱**：本地 Python 子进程（RestrictedPython）
