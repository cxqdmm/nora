<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nora 智能体实时监控面板</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #252526;
            --border-color: #3e3e42;
            --text-primary: #d4d4d4;
            --text-secondary: #858585;
            --accent-blue: #61afef;
            --accent-green: #98c379;
            --accent-yellow: #e5c07b;
            --accent-red: #e06c75;
            --accent-purple: #c678dd;
            --accent-cyan: #56b6c2;
            --font-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
        }

        body {
            font-family: var(--font-mono);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            font-size: 13px;
            line-height: 1.6;
            overflow-y: scroll;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header-title {
            font-weight: 600;
            color: var(--accent-blue);
            letter-spacing: 0.5px;
        }

        .status-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            background: #333;
            text-transform: uppercase;
            font-weight: bold;
        }
        .status-connected { color: var(--accent-green); background: rgba(152, 195, 121, 0.1); }
        .status-disconnected { color: var(--accent-red); background: rgba(224, 108, 117, 0.1); }

        /* Main Layout */
        #main-layout {
            display: flex;
            margin-top: 40px;
            height: calc(100vh - 40px);
        }

        #log-stream {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        #context-panel {
            width: 350px; /* Slightly wider for tabs */
            background: var(--panel-bg);
            display: flex;
            flex-direction: row; /* Horizontal layout for Tab bar + Content */
            border-left: 1px solid var(--border-color);
        }

        /* Vertical Tabs Sidebar */
        .context-tabs {
            width: 48px;
            background: #2c2c2d;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            flex-shrink: 0;
        }

        .tab-item {
            writing-mode: vertical-rl;
            text-orientation: upright;
            padding: 15px 10px;
            margin-bottom: 5px;
            cursor: pointer;
            color: var(--text-secondary);
            border-left: 3px solid transparent;
            font-size: 12px;
            letter-spacing: 4px;
            transition: all 0.2s;
            user-select: none;
        }

        .tab-item:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
        }

        .tab-item.active {
            color: var(--accent-blue);
            border-left: 3px solid var(--accent-blue);
            background: rgba(0,0,0,0.2);
            font-weight: bold;
        }

        /* Tab Content Area */
        .context-pages {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .tab-page {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            animation: fadeIn 0.2s ease;
        }

        .tab-page.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            padding: 10px 15px;
            background: #252526;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            color: var(--accent-yellow);
            font-size: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .code-block {
            font-size: 11px;
            white-space: pre-wrap;
            font-family: var(--font-mono);
        }

        /* Hide original context headers/list styles that conflict */
        .context-header { display: none; } /* We use .page-header now */
        
        /* Adjust Context List for new container */
        #context-list {
            padding: 0; /* Remove padding as .page-content has it */
        }
        
        .context-item {
            margin-bottom: 8px;
        }
        
        .context-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .context-source {
            background: rgba(255, 255, 255, 0.1);
            padding: 1px 4px;
            border-radius: 2px;
        }

        .context-empty {
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            margin-top: 20px;
        }

        /* Log Entries */
        .entry {
            display: flex;
            gap: 15px;
            padding: 4px 0;
            border-left: 2px solid transparent;
            margin-bottom: 2px;
        }

        .entry:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .ts {
            flex-shrink: 0;
            width: 80px;
            color: var(--text-secondary);
            font-size: 11px;
            text-align: right;
            user-select: none;
        }

        .content {
            flex-grow: 1;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        /* Phases */
        .entry.phase {
            margin-top: 30px;
            margin-bottom: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .entry.phase .content {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Turns */
        .entry.turn {
            margin-top: 20px;
            margin-bottom: 5px;
        }
        .entry.turn .content {
            color: var(--accent-cyan);
            font-weight: bold;
            border-left: 3px solid var(--accent-cyan);
            padding-left: 10px;
        }

        /* Tools */
        .entry.tool .content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .tool-header {
            display: flex;
            align-items: center;
        }
        .badge-tool {
            display: inline-block;
            background: rgba(198, 120, 221, 0.15);
            color: var(--accent-purple);
            padding: 0 6px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 8px;
            border: 1px solid rgba(198, 120, 221, 0.3);
            font-size: 11px;
        }
        .tool-name {
            color: var(--accent-purple);
            font-weight: bold;
        }
        .tool-args {
            color: var(--text-secondary);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 4px;
            border-left: 2px solid var(--accent-purple);
            font-family: var(--font-mono);
            white-space: pre-wrap;
        }

        /* Plan */
        .entry.plan {
            background: rgba(229, 192, 123, 0.05);
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid var(--accent-yellow);
            margin: 5px 0 5px 95px; /* Offset to align with content */
        }
        .entry.plan .ts { display: none; } /* Hide timestamp for internal plan block */
        .plan-label {
            display: block;
            color: var(--accent-yellow);
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }
        .plan-reasoning {
            color: var(--text-primary);
            font-style: italic;
        }

        /* Step */
        .entry.step .content {
            padding-left: 20px;
            color: var(--accent-green);
        }
        .step-id {
            font-weight: bold;
            margin-right: 5px;
        }

        /* LLM Messages */
        .entry.llm .content {
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 4px;
        }
        
        /* LLM Input Group */
        .llm-input-summary {
            cursor: pointer;
            font-weight: bold;
            color: var(--accent-purple);
            user-select: none;
        }
        .llm-input-summary:hover {
            color: var(--text-primary);
        }
        .badge-llm {
            background: rgba(198, 120, 221, 0.15);
            color: var(--accent-purple);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 8px;
        }
        .llm-input-details {
            margin-top: 10px;
            padding-left: 10px;
            border-left: 2px solid var(--border-color);
        }
        .llm-input-details.collapsed {
            display: none;
        }
        .llm-message-item {
            margin-bottom: 15px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 4px;
        }
        .message-content {
            white-space: pre-wrap;
            font-size: 12px;
            color: var(--text-secondary);
            max-height: 300px;
            overflow-y: auto;
        }

        .role-tag {
            display: inline-block;
            text-transform: uppercase;
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 4px;
            padding: 1px 4px;
            border-radius: 2px;
        }
        .role-system { color: #abb2bf; border: 1px solid #5c6370; }
        .role-user { color: var(--accent-blue); border: 1px solid var(--accent-blue); }
        .role-assistant { color: var(--accent-green); border: 1px solid var(--accent-green); }
        .role-memory { color: var(--accent-purple); border: 1px solid var(--accent-purple); }

        /* Code Blocks */
        .entry.code-execution .content {
            /* Remove default styling since we handle it in JS now */
            background: transparent;
            border: none;
            padding: 0;
        }

        /* Standard Logs */
        .entry.info .content { color: var(--text-primary); }
        .entry.success .content { color: var(--accent-green); }
        .entry.warn .content { color: var(--accent-yellow); }
        .entry.error .content { color: var(--accent-red); }
        .log-prefix {
            font-weight: bold;
            margin-right: 8px;
            opacity: 0.8;
        }

        /* Final Answer */
        .entry.final-answer {
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--accent-green);
            background: rgba(152, 195, 121, 0.1);
            border-radius: 6px;
            padding: 15px;
        }
        .entry.final-answer .content {
            color: var(--text-primary);
            font-size: 14px;
        }
        .final-answer-label {
            color: var(--accent-green);
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        /* Token Usage */
        .entry.usage {
            margin-top: 5px;
            margin-bottom: 5px;
            font-size: 11px;
        }
        .entry.usage .content {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 2px;
        }
        .usage-badge {
            background: #333;
            color: #d4d4d4;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 4px;
            font-weight: bold;
            font-size: 10px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .usage-source {
            display: inline-block;
            margin-right: 4px;
            color: var(--accent-purple);
            font-weight: bold;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .usage-divider {
            color: #555;
            margin: 0 4px;
            font-weight: normal;
        }
        .usage-item {
            color: var(--text-secondary);
            font-family: var(--font-mono);
            white-space: nowrap;
        }
        .usage-item strong {
            color: var(--accent-cyan);
            font-weight: normal;
        }
        .usage-item.total strong {
            color: var(--accent-yellow);
        }

        /* Tool Output */
        .tool-output-summary {
            cursor: pointer;
            font-weight: bold;
            color: var(--text-secondary);
            user-select: none;
            display: flex;
            align-items: center;
        }
        .tool-output-summary:hover {
            color: var(--text-primary);
        }
        .tool-output-details {
            margin-top: 5px;
            padding-left: 10px;
            border-left: 2px solid var(--border-color);
            overflow-x: auto;
        }

        /* Execution Result */
        .log-prefix.execution-result {
            color: var(--accent-green);
        }
        .tool-output-details.execution-output {
            background: #141414;
            color: #d4d4d4;
            padding: 10px;
            border-radius: 4px;
            font-family: var(--font-mono);
            border-left: 3px solid var(--accent-green);
        }

        /* Utils */
        .dim { opacity: 0.6; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

    </style>
</head>
<body>

<div class="header">
    <div class="header-title">NORA 智能体监控</div>
    <div id="status" class="status-badge status-disconnected">等待连接...</div>
</div>

<div id="main-layout">
    <div id="log-stream">
        <!-- Logs will appear here -->
    </div>
    <div id="context-panel">
        <div class="context-tabs">
            <div class="tab-item active" data-target="tab-scratchpad">白板</div>
            <div class="tab-item" data-target="tab-summary">摘要</div>
            <div class="tab-item" data-target="tab-memory">记忆</div>
        </div>

        <div class="context-pages">
            <!-- Page 1: Scratchpad -->
            <div id="tab-scratchpad" class="tab-page active">
                <div class="page-header" style="color: var(--accent-yellow);">全局任务白板 (SCRATCHPAD)</div>
                <div id="scratchpad-content" class="page-content code-block" style="color: var(--accent-yellow);">
                    <div class="context-empty">空</div>
                </div>
            </div>

            <!-- Page 2: Summary -->
            <div id="tab-summary" class="tab-page">
                <div class="page-header" style="color: var(--accent-cyan);">任务进度摘要 (SUMMARY)</div>
                <div id="running-summary-content" class="page-content code-block" style="color: var(--accent-cyan);">
                    <div class="context-empty">空</div>
                </div>
            </div>

            <!-- Page 3: Memory -->
            <div id="tab-memory" class="tab-page">
                <div class="page-header">
                    短期记忆 (WORKING MEMORY)
                    <span id="history-stats" style="float: right; font-size: 0.8em; color: #888;"></span>
                </div>
                <div id="context-list" class="page-content">
                    <div class="context-empty">无活跃上下文</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const stream = document.getElementById('log-stream');
    const contextList = document.getElementById('context-list');
    const scratchpadEl = document.getElementById('scratchpad-content');
    const runningSummaryEl = document.getElementById('running-summary-content');
    const statusEl = document.getElementById('status');
    let socket;

    function formatTime(isoString) {
        const d = new Date(isoString);
        return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' }) + 
               '.' + String(d.getMilliseconds()).padStart(3, '0');
    }

    let lastLogType = null; // Track previous log type for context

    function createEntry(log) {
        const div = document.createElement('div');
        div.className = `entry ${log.type}`;

        // Timestamp
        const ts = document.createElement('div');
        ts.className = 'ts';
        ts.textContent = formatTime(log.timestamp);
        
        // Content Container
        const content = document.createElement('div');
        content.className = 'content';

        // Custom Rendering based on type
        switch (log.type) {
            case 'phase':
                // Clean up the message "=== Phase: Planning ===" -> "Planning Phase"
                const phaseName = log.message.replace(/=== Phase: (.*?) ===/, '$1').trim();
                content.innerHTML = `<span>${phaseName}</span>`;
                break;

            case 'turn':
                // Clean up "--- Turn 1: Thinking... ---" -> "Turn 1: Thinking..."
                content.textContent = log.message.replace(/--- (.*?) ---/, '$1');
                break;

            case 'plan':
                // Special Card Layout for Plan
                div.className = 'entry plan';
                content.innerHTML = `
                    <span class="plan-label">规划策略 (Plan Strategy)</span>
                    <div class="plan-reasoning">${log.message}</div>
                `;
                // Plan entries are usually attached to a previous context, so we might want to hide timestamp or keep it
                // Based on CSS, TS is hidden for .plan
                break;

            case 'step':
                content.innerHTML = `<span class="step-id">步骤 ${log.id}:</span> ${log.message}`;
                break;

            case 'tool':
                // Check if this is an execute_code tool call
                if (log.name === 'execute_code') {
                    // Do not render the standard tool block for execute_code to avoid duplication
                    // because we have a specialized 'code' event type that handles it better.
                    // However, we still want to show that a tool was called, just maybe not the big JSON blob.
                    // Let's render a minimal badge instead.
                    
                    const rationale = log.args && log.args.rationale ? log.args.rationale : '';
                    const rationaleHtml = rationale ? `<div class="tool-args" style="margin-top:5px; color:#98c379; font-style:italic;">目标: ${escapeHtml(rationale)}</div>` : '';

                    content.innerHTML = `
                        <div class="tool-header">
                            <span class="badge-tool">工具调用</span>
                            <span class="tool-name">${log.name}</span>
                        </div>
                        ${rationaleHtml}
                    `;
                } else {
                    content.innerHTML = `
                        <div class="tool-header">
                            <span class="badge-tool">工具调用</span>
                            <span class="tool-name">${log.name}</span>
                        </div>
                        <div class="tool-args">${JSON.stringify(log.args, null, 2)}</div>
                    `;
                }
                break;
            
            case 'llm':
                const roleClass = `role-${log.role}`;
                content.innerHTML = `
                    <div class="role-tag ${roleClass}">${log.role}</div>
                    <div>${escapeHtml(log.message)}</div>
                `;
                break;

            case 'llm-output':
                // Collapsible container for LLM Output (similar to Input)
                div.className = 'entry llm-output';
                
                const outSummary = document.createElement('div');
                outSummary.className = 'llm-input-summary'; // Reuse style
                outSummary.innerHTML = `<span class="toggle-icon">▶</span> <span class="badge-llm" style="color:var(--accent-green); background:rgba(152, 195, 121, 0.15);">LLM 输出</span> <span class="role-tag role-${log.role}">${log.role}</span>`;
                
                const outDetails = document.createElement('div');
                outDetails.className = 'llm-input-details collapsed'; // Default collapsed
                
                const outContentDiv = document.createElement('div');
                outContentDiv.className = 'message-content';
                outContentDiv.innerHTML = escapeHtml(log.message);
                
                outDetails.appendChild(outContentDiv);

                outSummary.onclick = () => {
                    outDetails.classList.toggle('collapsed');
                    const icon = outSummary.querySelector('.toggle-icon');
                    icon.textContent = outDetails.classList.contains('collapsed') ? '▶' : '▼';
                };

                content.appendChild(outSummary);
                content.appendChild(outDetails);
                break;

            case 'llm-input':
                // Collapsible container for multiple messages
                div.className = 'entry llm-input';
                
                const summary = document.createElement('div');
                summary.className = 'llm-input-summary';
                
                // Add purpose badge if available
                const purpose = log.purpose ? `<span class="badge-llm" style="background:rgba(97, 175, 239, 0.15); color:var(--accent-blue); margin-left:8px;">${escapeHtml(log.purpose)}</span>` : '';
                
                summary.innerHTML = `<span class="toggle-icon">▶</span> <span class="badge-llm">LLM 输入</span> ${log.messages.length} 条消息 ${purpose}`;
                
                const details = document.createElement('div');
                details.className = 'llm-input-details collapsed';
                
                log.messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'llm-message-item';
                    const roleClass = `role-${msg.role}`;
                    
                    let contentStr = typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content);
                    
                    msgDiv.innerHTML = `
                        <div class="role-tag ${roleClass}">${msg.role}</div>
                        <div class="message-content">${escapeHtml(contentStr)}</div>
                    `;
                    details.appendChild(msgDiv);
                });

                summary.onclick = () => {
                    details.classList.toggle('collapsed');
                    const icon = summary.querySelector('.toggle-icon');
                    icon.textContent = details.classList.contains('collapsed') ? '▶' : '▼';
                };

                content.appendChild(summary);
                content.appendChild(details);
                break;

            case 'code':
                // Collapsible Code Execution (Default Collapsed)
                div.className = 'entry code-execution';
                
                const codeSummary = document.createElement('div');
                codeSummary.className = 'tool-output-summary'; // Reuse style
                codeSummary.innerHTML = `<span class="toggle-icon" style="margin-right: 5px;">▶</span> <span class="log-prefix">[代码执行]</span>`;
                
                const codeDetails = document.createElement('div');
                codeDetails.className = 'tool-output-details'; // Reuse style
                codeDetails.style.display = 'none'; // Default collapsed
                
                const pre = document.createElement('pre');
                pre.style.margin = '0';
                pre.style.background = '#141414';
                pre.style.padding = '10px';
                pre.style.borderRadius = '4px';
                pre.style.color = '#e5c07b';
                pre.textContent = log.message;
                
                codeDetails.appendChild(pre);

                codeSummary.onclick = () => {
                    const isCollapsed = codeDetails.style.display === 'none';
                    codeDetails.style.display = isCollapsed ? 'block' : 'none';
                    codeSummary.querySelector('.toggle-icon').textContent = isCollapsed ? '▼' : '▶';
                };

                content.appendChild(codeSummary);
                content.appendChild(codeDetails);
                break;

            case 'final-answer':
                content.innerHTML = `
                    <span class="final-answer-label">最终回答 (Final Answer)</span>
                    <div>${escapeHtml(log.message)}</div>
                `;
                break;

            case 'llm-usage':
                div.className = 'entry usage';
                const source = log.source || '未知';
                content.innerHTML = `
                    <span class="usage-badge">TOKEN 消耗</span>
                    <span class="usage-divider">·</span>
                    <span class="usage-source">${source}</span>
                    <span class="usage-divider">·</span>
                    <span class="usage-item">提示词: <strong>${log.usage.prompt_tokens}</strong></span>
                    <span class="usage-divider">·</span>
                    <span class="usage-item">补全: <strong>${log.usage.completion_tokens}</strong></span>
                    <span class="usage-divider">·</span>
                    <span class="usage-item total">总计: <strong>${log.usage.total_tokens}</strong></span>
                `;
                break;

            case 'context-update':
                updateContextPanel(log.items);
                break;

            default: // info, success, warn, error
                if (log.prefix === 'ToolOutput') {
                    // Check if previous log was code execution
                    let label = '[工具输出]';
                    let labelClass = 'log-prefix';
                    
                    if (lastLogType === 'code') {
                        label = '[执行结果]';
                        labelClass = 'log-prefix execution-result';
                    }

                    // Collapsible Tool Output (Default Expanded)
                    const summary = document.createElement('div');
                    summary.className = 'tool-output-summary';
                    summary.innerHTML = `<span class="toggle-icon" style="margin-right: 5px;">▼</span> <span class="${labelClass}">${label}</span>`;
                    
                    const details = document.createElement('div');
                    details.className = 'tool-output-details';
                    // Apply special styling if it's an execution result
                    if (lastLogType === 'code') {
                        details.classList.add('execution-output');
                    }
                    details.textContent = log.message;

                    summary.onclick = () => {
                        const isCollapsed = details.style.display === 'none';
                        details.style.display = isCollapsed ? 'block' : 'none';
                        summary.querySelector('.toggle-icon').textContent = isCollapsed ? '▼' : '▶';
                    };

                    content.appendChild(summary);
                    content.appendChild(details);
                } else {
                    if (log.prefix) {
                        const prefixSpan = document.createElement('span');
                        prefixSpan.className = 'log-prefix';
                        prefixSpan.textContent = `[${log.prefix}]`;
                        content.appendChild(prefixSpan);
                    }
                    content.appendChild(document.createTextNode(log.message));
                }
        }
        
        // Update last log type
        lastLogType = log.type;

        // Assembly
        div.appendChild(ts);
        div.appendChild(content);
        return div;
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function updateContextPanel(items) {
        contextList.innerHTML = '';
        
        if (!items || items.length === 0) {
            contextList.innerHTML = '<div class="context-empty">无活跃上下文</div>';
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'context-item';
            
            // Create summary part (always visible)
            const summaryDiv = document.createElement('div');
            summaryDiv.innerHTML = `
                <div class="context-meta">
                    <span class="context-source">${item.source || '未知'}</span>
                    <span class="context-time">${formatTime(new Date(item.timestamp))}</span>
                </div>
                <div class="context-content" style="cursor: pointer;" title="点击展开详情">
                    <span class="toggle-icon">▶</span> ${escapeHtml(item.content)}
                </div>
            `;
            
            // Create details part (hidden by default)
            const detailsDiv = document.createElement('div');
            detailsDiv.style.display = 'none';
            detailsDiv.style.marginTop = '8px';
            detailsDiv.style.paddingTop = '8px';
            detailsDiv.style.borderTop = '1px solid var(--border-color)';
            detailsDiv.style.fontSize = '11px';
            detailsDiv.style.color = '#aaa';
            detailsDiv.style.whiteSpace = 'pre-wrap';
            detailsDiv.style.maxHeight = '300px';
            detailsDiv.style.overflowY = 'auto';
            detailsDiv.textContent = item.fullContent || '(无详情)';

            // Toggle logic
            summaryDiv.querySelector('.context-content').onclick = () => {
                const isCollapsed = detailsDiv.style.display === 'none';
                detailsDiv.style.display = isCollapsed ? 'block' : 'none';
                summaryDiv.querySelector('.toggle-icon').textContent = isCollapsed ? '▼' : '▶';
            };

            div.appendChild(summaryDiv);
            div.appendChild(detailsDiv);
            contextList.appendChild(div);
        });
    }

    function connect() {
        socket = new WebSocket('ws://localhost:3000');

        socket.onopen = () => {
            statusEl.textContent = '已连接';
            statusEl.className = 'status-badge status-connected';
            addSystemLog('已连接到实时日志服务器');
        };

        socket.onclose = () => {
            statusEl.textContent = '断开连接';
            statusEl.className = 'status-badge status-disconnected';
            setTimeout(connect, 2000);
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                // Handle history stats (no log entry)
                if (data.type === 'history-stats') {
                    const statsEl = document.getElementById('history-stats');
                    if (statsEl) {
                        statsEl.textContent = `历史记录: ${data.count}/${data.max}`;
                    }
                    return;
                }

                if (data.type === 'scratchpad-update') {
                    scratchpadEl.textContent = data.content || '(空)';
                    return;
                }

                if (data.type === 'running-summary-update') {
                    runningSummaryEl.textContent = data.content || '(空)';
                    return;
                }

                const el = createEntry(data);
                stream.appendChild(el);
                window.scrollTo(0, document.body.scrollHeight);
            } catch (e) {
                console.error(e);
            }
        };
    }

    function addSystemLog(msg) {
        const el = createEntry({
            type: 'info',
            prefix: 'System',
            message: msg,
            timestamp: new Date().toISOString()
        });
        stream.appendChild(el);
    }

    // Tab Switching Logic
    document.querySelectorAll('.tab-item').forEach(item => {
        item.addEventListener('click', () => {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            // Add active class to clicked tab
            item.classList.add('active');
            
            // Hide all pages
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            // Show target page
            const targetId = item.getAttribute('data-target');
            document.getElementById(targetId).classList.add('active');
        });
    });

    connect();
</script>

</body>
</html>
